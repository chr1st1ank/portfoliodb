# https://taskfile.dev

version: "3"

tasks:
  makemigrations:
    desc: "Make Django DB migrations"
    cmds:
      - uv run --directory=backend python manage.py makemigrations

  clear-data:
    desc: "Clear DB"
    cmds:
      - rm backend/db.sqlite3
      - uv run --directory=backend python manage.py migrate --noinput

  sample-data:
    desc: "Load sample data into DB"
    cmds:
      - rm backend/db.sqlite3
      - uv run --directory=backend python manage.py migrate --noinput
      - uv run --directory=backend python manage.py loaddata sample_data.json
    silent: false

  real-data:
    desc: "Load real data into DB"
    cmds:
      - python local/read_sql.py
      - rm backend/db.sqlite3
      - uv run --directory=backend python manage.py migrate --noinput
      - uv run --directory=backend python manage.py loaddata real_data.json
    silent: false

  start-backend:
    desc: "Start Django backend server"
    cmds:
      - uv run --directory=backend python manage.py migrate --noinput
      - uv run --directory=backend python manage.py runserver 0.0.0.0:8000
    silent: false

  start-frontend:
    desc: "Start Vite frontend development server"
    cmds:
      - cd frontend && npm run dev
    silent: false

  test:
    desc: "Run all tests"
    cmds:
      - task: backend-test
      - task: frontend-test
      - task: rust-test

  backend-test:
    desc: "Run backend tests"
    cmds:
      - cd backend && uv run ruff format
      - cd backend && uv run ruff check --fix
      - cd backend && uv run python manage.py check
      - cd backend && uv run python manage.py test
    silent: false

  frontend-test:
    desc: "Run frontend tests with Vitest"
    cmds:
      - cd frontend && npx vitest --run
    silent: false

  # Rust backend tasks
  rust-build:
    desc: "Build Rust backend (debug)"
    dir: backend-rust
    cmds:
      - cargo build

  rust-build-release:
    desc: "Build Rust backend (release/optimized)"
    dir: backend-rust
    cmds:
      - cargo build --release

  rust-check:
    desc: "Check Rust code without building"
    dir: backend-rust
    cmds:
      - cargo check

  rust-test:
    desc: "Run all Rust tests"
    dir: backend-rust
    cmds:
      - cargo test

  rust-online-tests:
    desc: "Run all Rust online tests"
    dir: backend-rust
    cmds:
      - cargo test -- --ignored

  rust-clean:
    desc: "Clean Rust build artifacts"
    dir: backend-rust
    cmds:
      - cargo clean

  api-serve:
    desc: "Start the Rust backend"
    dir: backend-rust
    cmds:
      - pkill -f portfoliodb-rust || true
      - cargo run

  api-ingest:
    desc: "Ingest minimal dataset"
    cmds:
      - sleep 1
      # - until curl -s http://localhost:8001/health > /dev/null 2>&1; do sleep 1; done
      - python scripts/ingest_data.py --dataset minimal --api-url http://localhost:8001

  api-serve-minimal-data:
    desc: "Run backend API with minimal sample dataset"
    deps: [api-serve, api-ingest]

  api-test:
    desc: "Run API integration tests against Rust backend"
    dir: backend-rust
    cmds:
      - pkill -f portfoliodb-rust || true
      - cargo build
      - cargo run > /dev/null 2>&1 &
      - defer: pkill -f portfoliodb-rust
      - sleep 1
      - python ../scripts/ingest_data.py --dataset minimal --api-url http://localhost:8001
      - python ../scripts/api_test.py --dataset minimal --api-url http://localhost:8001

  codex:
    desc: "Run Codex"
    cmds:
      - start-codex --project-doc docs/architecture.md
    silent: false
